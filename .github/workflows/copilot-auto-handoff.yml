name: Cloud Agent Auto-handoff

on:
  issues:
    types: [labeled]

permissions:
  contents: read

jobs:
  # Cloud Agent workflow - uses Pro+ account token for Copilot agent access
  # IMPORTANT: The token must be from a Copilot Pro/Pro+ account (sirjamesoffordii)
  # Tokens from free accounts (Alpha-Tech-Lead, Software-Engineer-Agent) cannot
  # access the agent_assignment API.
  #
  # Cloud agents are for SIMPLE ISSUES ONLY (complexity score 0-2)
  assign_to_copilot:
    name: Assign to Cloud Agent
    if: github.event.label.name == 'agent:copilot-swe'
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Assign issue to Cloud Agent
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_ASSIGN_TOKEN_PRO }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const assignees = (context.payload.issue.assignees ?? []).map(a => a.login);
            if (assignees.includes('copilot-swe-agent[bot]') || assignees.includes('copilot-swe-agent')) {
              core.info('Cloud Agent is already assigned.');
              return;
            }

            const target_repo = `${owner}/${repo}`;

            await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/assignees', {
              owner,
              repo,
              issue_number,
              assignees: ['copilot-swe-agent[bot]'],
              agent_assignment: {
                target_repo,
                base_branch: 'staging',
                custom_instructions: [
                  '## Role: Cloud Agent (Simple SWE Work)',
                  'You are acting as a Cloud Agent handling simple Software Engineer work.',
                  'This issue has been scored as complexity 0-2 (simple).',
                  '',
                  '## Setup',
                  'Work from the `staging` branch and open a PR targeting `staging`.',
                  'Read: AGENTS.md, .github/copilot-instructions.md',
                  '',
                  '## Operating Mode',
                  'Operate in loop mode: keep taking the next best safe step until Done.',
                  'Keep the diff small and scoped to the issue.',
                  '',
                  '## Verification',
                  'Run the cheapest relevant checks (e.g. `pnpm check`, `pnpm test`).',
                  'Include evidence in the PR description.',
                  '',
                  '## Completion',
                  'When you open a PR, include `Closes #' + issue_number + '` in the description.',
                  'An automated workflow will notify @Alpha-Tech-Lead when you open the PR.'
                ].join('\n')
              },
              headers: {
                'Accept': 'application/vnd.github+json',
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });

            core.info(`Assigned issue #${issue_number} to Cloud Agent (copilot-swe-agent[bot])`);
