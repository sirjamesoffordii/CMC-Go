name: Test and Code Coverage

on:
push:
branches: [ main, develop ]
        pull_request:
            branches: [ main, develop ]

            jobs:
              test-and-coverage:
                  runs-on: ubuntu-latest

                          services:
                                postgres:
                                        image: postgres:15
                                                env:
                                                          POSTGRES_USER: root
                                                                    POSTGRES_PASSWORD: password
                                                                              POSTGRES_DB: cmc_test
                                                                                      options: >-
                                                                                                --health-cmd pg_isready
                                                                                                          --health-interval 10s
                                                                                                                    --health-timeout 5s
                                                                                                                              --health-retries 5
                                                                                                                                      ports:
                                                                                                                                                - 5432:5432
                                                                                                                                                
                                                                                                                                                    steps:
                                                                                                                                                          - uses: actions/checkout@v4
                                                                                                                                                                
                                                                                                                                                                      - name: Setup pnpm
                                                                                                                                                                              uses: pnpm/action-setup@v2
                                                                                                                                                                                      with:
                                                                                                                                                                                                version: 8
                                                                                                                                                                                                      
                                                                                                                                                                                                            - name: Setup Node.js
                                                                                                                                                                                                                    uses: actions/setup-node@v4
                                                                                                                                                                                                                            with:
                                                                                                                                                                                                                                      node-version: '18'
                                                                                                                                                                                                                                                cache: 'pnpm'
                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                            - name: Install dependencies
                                                                                                                                                                                                                                                                    run: pnpm install --frozen-lockfile
                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                - name: Run tests with coverage
                                                                                                                                                                                                                                                                                        run: pnpm jest --coverage
                                                                                                                                                                                                                                                                                                env:
                                                                                                                                                                                                                                                                                                          DATABASE_URL: postgres://root:password@localhost:5432/cmc_test
                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                      - name: Upload coverage reports to Codecov
                                                                                                                                                                                                                                                                                                                              uses: codecov/codecov-action@v5
                                                                                                                                                                                                                                                                                                                                      with:
                                                                                                                                                                                                                                                                                                                                                token: ${{ secrets.CODECOV_TOKEN }}
                                                                                                                                                                                                                                                                                                                                                          files: ./coverage/coverage-final.json
                                                                                                                                                                                                                                                                                                                                                                    flags: unittests
                                                                                                                                                                                                                                                                                                                                                                              name: codecov-umbrella
                                                                                                                                                                                                                                                                                                                                                                                        fail_ci_if_error: false
