name: Auto Project Sync

# Automatically add new Issues/PRs to Project 4 and sync status changes
# This ensures the board always reflects reality without manual intervention

on:
  issues:
    types: [opened, reopened, labeled]
  pull_request:
    types: [opened, ready_for_review, closed]

permissions:
  contents: read
  issues: write
  pull-requests: write
  projects: write

env:
  PROJECT_NUMBER: 4
  PROJECT_ID: "PVT_kwHODqX6Qs4BNUfu"
  STATUS_FIELD_ID: "PVTSSF_lAHODqX6Qs4BNUfuzg8WaYA"
  # Status option IDs for Project 4
  STATUS_TODO: "f75ad846"
  STATUS_IN_PROGRESS: "47fc9ee4"
  STATUS_VERIFY: "5351d827"
  STATUS_DONE: "98236657"
  STATUS_BLOCKED: "652442a1"

jobs:
  # Add new Issues to Project 4
  add-issue-to-project:
    name: Add Issue to Project
    if: |
      github.event_name == 'issues' && (
        github.event.action == 'opened' ||
        github.event.action == 'reopened' ||
        (github.event.action == 'labeled' && github.event.label.name == 'agent:copilot-swe')
      )
    runs-on: ubuntu-latest
    steps:
      - name: Add Issue to Project 4
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_AUTOMATION_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const mutation = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemByContentId(input: {
                  projectId: $projectId
                  contentId: $contentId
                }) {
                  item {
                    id
                  }
                }
              }
            `;

            try {
              const result = await github.graphql(mutation, {
                projectId: process.env.PROJECT_ID,
                contentId: context.payload.issue.node_id
              });
              core.info(`Added Issue #${context.payload.issue.number} to Project 4`);
              core.info(`Item ID: ${result.addProjectV2ItemByContentId.item.id}`);
            } catch (error) {
              // May fail if already in project - that's OK
              if (error.message.includes('already')) {
                core.info(`Issue #${context.payload.issue.number} already in Project 4`);
              } else {
                core.warning(`Could not add to project: ${error.message}`);
              }
            }

  # Add new PRs to Project 4 and set status based on PR state
  add-pr-to-project:
    name: Add PR to Project
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Add PR to Project 4
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_AUTOMATION_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const addMutation = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemByContentId(input: {
                  projectId: $projectId
                  contentId: $contentId
                }) {
                  item {
                    id
                  }
                }
              }
            `;

            const pr = context.payload.pull_request;
            let itemId;

            try {
              const result = await github.graphql(addMutation, {
                projectId: process.env.PROJECT_ID,
                contentId: pr.node_id
              });
              itemId = result.addProjectV2ItemByContentId.item.id;
              core.info(`Added PR #${pr.number} to Project 4, Item ID: ${itemId}`);
            } catch (error) {
              if (error.message.includes('already')) {
                core.info(`PR #${pr.number} already in Project 4`);
                // Need to find the item ID for status update
                // For now, skip status update if we can't get the item ID
                return;
              } else {
                core.warning(`Could not add PR to project: ${error.message}`);
                return;
              }
            }

            // Determine status based on PR state
            let statusOptionId;
            let statusName;

            if (pr.merged) {
              statusOptionId = process.env.STATUS_DONE;
              statusName = 'Done';
            } else if (pr.draft) {
              statusOptionId = process.env.STATUS_IN_PROGRESS;
              statusName = 'In Progress';
            } else {
              // Ready for review â†’ Verify status
              statusOptionId = process.env.STATUS_VERIFY;
              statusName = 'Verify';
            }

            // Update status
            const updateMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;

            try {
              await github.graphql(updateMutation, {
                projectId: process.env.PROJECT_ID,
                itemId: itemId,
                fieldId: process.env.STATUS_FIELD_ID,
                optionId: statusOptionId
              });
              core.info(`Set PR #${pr.number} status to: ${statusName}`);
            } catch (error) {
              core.warning(`Could not update status: ${error.message}`);
            }

  # When PR is merged, set linked Issues to Done
  close-linked-issues:
    name: Update Linked Issues on Merge
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Find and update linked Issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_AUTOMATION_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            // Find issue references like "Closes #123" or "Fixes #456"
            const issuePattern = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s*#(\d+)/gi;
            const matches = [...body.matchAll(issuePattern)];

            if (matches.length === 0) {
              core.info('No linked issues found in PR body');
              return;
            }

            core.info(`Found ${matches.length} linked issue(s)`);

            // Note: Setting project item status requires finding the item ID first
            // This is complex with GraphQL, so for now we just log
            // The Issues themselves get closed automatically by GitHub
            for (const match of matches) {
              const issueNumber = match[1];
              core.info(`Issue #${issueNumber} will be closed by GitHub (status sync TODO)`);
            }

            // TODO: When Blocked/Verify statuses exist, implement full status sync
            // This would require:
            // 1. Query project items to find item ID for each issue
            // 2. Update status field to Done
