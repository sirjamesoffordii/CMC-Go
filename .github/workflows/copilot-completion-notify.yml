name: Notify TL on Cloud Agent PR

on:
  pull_request:
    types: [opened]

jobs:
  notify_tl:
    # Only run for PRs from the Copilot bot
    if: github.event.pull_request.user.login == 'copilot-swe-agent[bot]'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write

    steps:
      - name: Extract linked issue
        id: extract
        uses: actions/github-script@v8
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            // Look for "Closes #123" or "Fixes #123" patterns
            const match = body.match(/(?:closes|fixes|resolves)\s+#(\d+)/i);
            if (match) {
              return match[1];
            }
            return '';
          result-encoding: string

      - name: Add completion comment to PR
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: [
                '## ðŸ¤– Cloud Agent Completion Notice',
                '',
                `@Alpha-Tech-Lead â€” Copilot coding agent has opened this PR.`,
                '',
                '**Next steps:**',
                '1. Review the changes',
                '2. Check evidence in PR description',
                '3. Update Project status if needed',
                '4. Approve/request changes',
                '',
                '---',
                '*This notification was auto-generated by the cloud agent completion workflow.*'
              ].join('\n')
            });

      - name: Comment on linked issue (if found)
        if: steps.extract.outputs.result != ''
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt('${{ steps.extract.outputs.result }}');
            const pr = context.payload.pull_request;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                '## ðŸ¤– Cloud Agent Update',
                '',
                `@Alpha-Tech-Lead â€” PR #${pr.number} has been opened for this issue.`,
                '',
                `**PR:** ${pr.html_url}`,
                `**Status:** Ready for review`,
                '',
                '---',
                '*This notification was auto-generated.*'
              ].join('\n')
            });
