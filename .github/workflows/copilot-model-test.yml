name: Copilot Model Selection Test

# Test different approaches to model selection with Copilot cloud agent
# This workflow creates separate triggers for each model we want to test

on:
  issues:
    types: [labeled]

permissions:
  contents: read

jobs:
  # ============================================================================
  # TEST 1: Explicit model parameter in agent_assignment (may not work)
  # ============================================================================
  test_model_param_codex:
    name: "Test: model param (Codex)"
    if: github.event.label.name == 'test:model-param-codex'
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Assign with explicit model parameter
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_ASSIGN_TOKEN_TL }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const assignees = (context.payload.issue.assignees ?? []).map(a => a.login);
            if (assignees.includes('copilot-swe-agent[bot]')) {
              core.info('Copilot is already assigned.');
              return;
            }

            // TEST: Try passing model directly in agent_assignment
            await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/assignees', {
              owner,
              repo,
              issue_number,
              assignees: ['copilot-swe-agent[bot]'],
              agent_assignment: {
                target_repo: `${owner}/${repo}`,
                base_branch: 'staging',
                model: 'gpt-5.2-codex',  // <-- TEST: Does this work?
                custom_instructions: [
                  '## Model Selection Test',
                  'This is a test to verify model selection via API parameter.',
                  '',
                  '**IMPORTANT:** Report which model you are using in your first message.',
                  'Include the model name in the PR description.',
                  '',
                  '## Task',
                  'Create a file at `test-results/model-test-codex-param.md` containing:',
                  '- The model you are running',
                  '- Timestamp',
                  '- Confirmation that this was triggered via `test:model-param-codex` label'
                ].join('\n')
              },
              headers: {
                'Accept': 'application/vnd.github+json',
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });

            core.info('Assigned with model parameter test (Codex).');

  test_model_param_opus:
    name: "Test: model param (Opus)"
    if: github.event.label.name == 'test:model-param-opus'
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Assign with explicit model parameter
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_ASSIGN_TOKEN_TL }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const assignees = (context.payload.issue.assignees ?? []).map(a => a.login);
            if (assignees.includes('copilot-swe-agent[bot]')) {
              core.info('Copilot is already assigned.');
              return;
            }

            // TEST: Try passing model directly in agent_assignment
            await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/assignees', {
              owner,
              repo,
              issue_number,
              assignees: ['copilot-swe-agent[bot]'],
              agent_assignment: {
                target_repo: `${owner}/${repo}`,
                base_branch: 'staging',
                model: 'claude-opus-4.5',  // <-- TEST: Does this work?
                custom_instructions: [
                  '## Model Selection Test',
                  'This is a test to verify model selection via API parameter.',
                  '',
                  '**IMPORTANT:** Report which model you are using in your first message.',
                  'Include the model name in the PR description.',
                  '',
                  '## Task',
                  'Create a file at `test-results/model-test-opus-param.md` containing:',
                  '- The model you are running',
                  '- Timestamp',
                  '- Confirmation that this was triggered via `test:model-param-opus` label'
                ].join('\n')
              },
              headers: {
                'Accept': 'application/vnd.github+json',
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });

            core.info('Assigned with model parameter test (Opus).');

  # ============================================================================
  # TEST 2: Model request in custom_instructions (natural language)
  # ============================================================================
  test_instructions_codex:
    name: "Test: instructions (Codex)"
    if: github.event.label.name == 'test:instructions-codex'
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Assign with model in instructions
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_ASSIGN_TOKEN_TL }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const assignees = (context.payload.issue.assignees ?? []).map(a => a.login);
            if (assignees.includes('copilot-swe-agent[bot]')) {
              core.info('Copilot is already assigned.');
              return;
            }

            // TEST: Request model via natural language instructions
            await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/assignees', {
              owner,
              repo,
              issue_number,
              assignees: ['copilot-swe-agent[bot]'],
              agent_assignment: {
                target_repo: `${owner}/${repo}`,
                base_branch: 'staging',
                custom_instructions: [
                  '## CRITICAL: Model Selection',
                  'You MUST use the GPT-5.2-Codex model for this task.',
                  'If you cannot select this model, state which model you are using.',
                  '',
                  '## Model Selection Test',
                  'This is a test to verify model selection via natural language instructions.',
                  '',
                  '**IMPORTANT:** Report which model you are using in your first message.',
                  'Include the model name in the PR description.',
                  '',
                  '## Task',
                  'Create a file at `test-results/model-test-codex-instructions.md` containing:',
                  '- The model you are running',
                  '- Timestamp',
                  '- Confirmation that this was triggered via `test:instructions-codex` label'
                ].join('\n')
              },
              headers: {
                'Accept': 'application/vnd.github+json',
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });

            core.info('Assigned with instructions model request (Codex).');

  test_instructions_opus:
    name: "Test: instructions (Opus)"
    if: github.event.label.name == 'test:instructions-opus'
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Assign with model in instructions
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_ASSIGN_TOKEN_TL }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const assignees = (context.payload.issue.assignees ?? []).map(a => a.login);
            if (assignees.includes('copilot-swe-agent[bot]')) {
              core.info('Copilot is already assigned.');
              return;
            }

            // TEST: Request model via natural language instructions
            await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/assignees', {
              owner,
              repo,
              issue_number,
              assignees: ['copilot-swe-agent[bot]'],
              agent_assignment: {
                target_repo: `${owner}/${repo}`,
                base_branch: 'staging',
                custom_instructions: [
                  '## CRITICAL: Model Selection',
                  'You MUST use the Claude Opus 4.5 model for this task.',
                  'If you cannot select this model, state which model you are using.',
                  '',
                  '## Model Selection Test',
                  'This is a test to verify model selection via natural language instructions.',
                  '',
                  '**IMPORTANT:** Report which model you are using in your first message.',
                  'Include the model name in the PR description.',
                  '',
                  '## Task',
                  'Create a file at `test-results/model-test-opus-instructions.md` containing:',
                  '- The model you are running',
                  '- Timestamp',
                  '- Confirmation that this was triggered via `test:instructions-opus` label'
                ].join('\n')
              },
              headers: {
                'Accept': 'application/vnd.github+json',
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });

            core.info('Assigned with instructions model request (Opus).');

  # ============================================================================
  # TEST 3: Baseline - No model specification (control group)
  # ============================================================================
  test_baseline:
    name: "Test: baseline (no model spec)"
    if: github.event.label.name == 'test:baseline'
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Assign without model specification
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_ASSIGN_TOKEN_TL }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const assignees = (context.payload.issue.assignees ?? []).map(a => a.login);
            if (assignees.includes('copilot-swe-agent[bot]')) {
              core.info('Copilot is already assigned.');
              return;
            }

            // TEST: Baseline - no model specification
            await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/assignees', {
              owner,
              repo,
              issue_number,
              assignees: ['copilot-swe-agent[bot]'],
              agent_assignment: {
                target_repo: `${owner}/${repo}`,
                base_branch: 'staging',
                custom_instructions: [
                  '## Model Selection Test - BASELINE',
                  'This is a baseline test with no model specification.',
                  '',
                  '**IMPORTANT:** Report which model you are using in your first message.',
                  'Include the model name in the PR description.',
                  '',
                  '## Task',
                  'Create a file at `test-results/model-test-baseline.md` containing:',
                  '- The model you are running',
                  '- Timestamp',
                  '- Confirmation that this was triggered via `test:baseline` label'
                ].join('\n')
              },
              headers: {
                'Accept': 'application/vnd.github+json',
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });

            core.info('Assigned baseline test (no model spec).');
