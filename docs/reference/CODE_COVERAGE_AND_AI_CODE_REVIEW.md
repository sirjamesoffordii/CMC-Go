# Code Coverage & AI Code Review Setup

## Overview

This document covers the setup and configuration of code coverage tracking with **Codecov** and **AI-powered code review** features integrated into the CMC-Go project.

### Current Status ✅
- **Code Coverage Insights**: Enabled in Sentry organization settings
- - **Codecov Integration**: Configured and tracking coverage metrics
  - - **GitHub Actions Workflow**: Deployed to automatically run tests and upload coverage
    - - **AI Code Review (Beta)**: Enabled in Sentry organization settings
     
      - ---

      ## Code Coverage with Codecov

      ### What is Codecov?

      Codecov is a code coverage analytics platform that helps teams:
      - Identify untested code and test gaps
      - - Track coverage trends over time
        - - Set coverage targets and goals
          - - Review coverage impact in pull requests
           
            - ### Setup Status
           
            - #### 1. GitHub Actions Workflow
            - The testing and coverage workflow is configured at `.github/workflows/test-and-coverage.yml` and automatically:
            - - Runs on every push to `main` and `develop` branches
              - - Runs on all pull requests targeting these branches
                - - Executes Jest test suite with coverage reports
                  - - Uploads coverage reports to Codecov
                   
                    - #### 2. Required Secrets
                    - To enable coverage uploads, add this secret to your GitHub repository:
                   
                    - **Secret Name**: `CODECOV_TOKEN`
                    - - Obtain from: https://app.codecov.io/github/sirjamesoffordii/CMC-Go
                      - - Add to: GitHub Repository → Settings → Secrets and variables → Actions
                       
                        - Steps to add the secret:
                        - 1. Go to your GitHub repository Settings
                          2. 2. Navigate to "Secrets and variables" → "Actions"
                             3. 3. Click "New repository secret"
                                4. 4. Name: `CODECOV_TOKEN`
                                   5. 5. Value: (Paste the token from Codecov dashboard)
                                      6. 6. Click "Add secret"
                                        
                                         7. #### 3. Workflow Configuration Details
                                        
                                         8. The `test-and-coverage.yml` includes:
                                        
                                         9. **Services**:
                                         10. - PostgreSQL 15 (for database-dependent tests)
                                             -   - User: `root`
                                                 -   - Password: `password`
                                                     -   - Database: `cmc_test`
                                                      
                                                         - **Build Steps**:
                                                         - 1. Checkout code (`actions/checkout@v4`)
                                                           2. 2. Setup pnpm package manager
                                                              3. 3. Setup Node.js 18 with dependency caching
                                                                 4. 4. Install dependencies with frozen lockfile
                                                                    5. 5. Run Jest with coverage flag (`pnpm jest --coverage`)
                                                                       6. 6. Upload coverage to Codecov using `codecov/codecov-action@v5`
                                                                         
                                                                          7. **Environment Variables**:
                                                                          8. - `DATABASE_URL`: Set to PostgreSQL test database connection string
                                                                            
                                                                             - ### Monitoring Coverage
                                                                            
                                                                             - #### Codecov Dashboard
                                                                             - - Visit: https://app.codecov.io/github/sirjamesoffordii/CMC-Go
                                                                               - - View coverage metrics for all branches
                                                                                 - - Track historical trends
                                                                                   - - Set coverage requirements for pull requests
                                                                                    
                                                                                     - #### Pull Request Integration
                                                                                     - When coverage is properly configured:
                                                                                     - - Codecov bot automatically comments on PRs with coverage reports
                                                                                       - - Shows coverage change (+ or - percentage)
                                                                                         - - Compares new code coverage to base branch
                                                                                           - - Can fail CI if coverage drops below threshold (configurable)
                                                                                            
                                                                                             - ### Coverage Reports
                                                                                            
                                                                                             - The workflow generates coverage reports in JSON format:
                                                                                             - - Location: `./coverage/coverage-final.json`
                                                                                               - - Format: JSON (automatically parsed by Codecov)
                                                                                                 - - Files Tracked: All Jest coverage output
                                                                                                  
                                                                                                   - ### Best Practices
                                                                                                  
                                                                                                   - 1. **Run tests locally** before pushing:
                                                                                                     2.    ```bash
                                                                                                              pnpm jest --coverage
                                                                                                              ```
                                                                                                           
                                                                                                           2. **Review coverage reports** to identify gaps:
                                                                                                           3.    - Focus on critical paths and business logic
                                                                                                                 -    - Aim for >80% coverage on core functionality
                                                                                                                  
                                                                                                                      - 3. **Set coverage thresholds** in Jest configuration (`jest.config.js`):
                                                                                                                        4.    ```javascript
                                                                                                                                 coverageThreshold: {
                                                                                                                                   global: {
                                                                                                                                     lines: 80,
                                                                                                                                     functions: 80,
                                                                                                                                     branches: 75,
                                                                                                                                     statements: 80
                                                                                                                                   }
                                                                                                                                 }
                                                                                                                                 ```
                                                                                                                              
                                                                                                                              4. **Exclude files from coverage** if needed:
                                                                                                                              5.    - Test utilities
                                                                                                                                    -    - Type definitions
                                                                                                                                         -    - Generated files
                                                                                                                                          
                                                                                                                                              - ---
                                                                                                                                              
                                                                                                                                              ## AI Code Review (Beta)
                                                                                                                                              
                                                                                                                                              ### What is Sentry's AI Code Review?
                                                                                                                                              
                                                                                                                                              Sentry's AI Code Review is a beta feature that:
                                                                                                                                              - Uses generative AI to review code in pull requests
                                                                                                                                              - - Identifies potential bugs and issues
                                                                                                                                                - - Suggests improvements for code quality
                                                                                                                                                  - - Integrates with GitHub for seamless workflow
                                                                                                                                                    - - Helps find issues before they reach production
                                                                                                                                                     
                                                                                                                                                      - ### Current Setup
                                                                                                                                                     
                                                                                                                                                      - **Status**: ✅ **ENABLED**
                                                                                                                                                     
                                                                                                                                                      - Location: Sentry Organization Settings → General Settings → "Enable AI Code Review"
                                                                                                                                                     
                                                                                                                                                      - The feature is now active for your organization and will automatically analyze pull requests.
                                                                                                                                                     
                                                                                                                                                      - ### Enabling the Feature
                                                                                                                                                     
                                                                                                                                                      - If not already enabled:
                                                                                                                                                     
                                                                                                                                                      - 1. Go to Sentry Dashboard (https://sir-james-offord-ii.sentry.io)
                                                                                                                                                        2. 2. Click Settings (gear icon)
                                                                                                                                                           3. 3. Navigate to Organization Settings → General
                                                                                                                                                              4. 4. Find "Enable AI Code Review" section (marked with "Beta" badge)
                                                                                                                                                                 5. 5. Toggle the switch to enable
                                                                                                                                                                    6. 6. Save changes
                                                                                                                                                                      
                                                                                                                                                                       7. ### Using AI Code Review
                                                                                                                                                                      
                                                                                                                                                                       8. #### How It Works
                                                                                                                                                                      
                                                                                                                                                                       9. 1. **Create a Pull Request** in your GitHub repository
                                                                                                                                                                          2. 2. **Sentry's AI Agent** automatically analyzes:
                                                                                                                                                                             3.    - Code changes and additions
                                                                                                                                                                                   -    - Potential bugs and logic errors
                                                                                                                                                                                        -    - Security vulnerabilities
                                                                                                                                                                                             -    - Code quality issues
                                                                                                                                                                                                  -    - Performance concerns
                                                                                                                                                                                                   
                                                                                                                                                                                                       - 3. **Review Comments** are posted to the PR with:
                                                                                                                                                                                                         4.    - Issue identification
                                                                                                                                                                                                               -    - Risk assessment
                                                                                                                                                                                                                    -    - Suggested fixes or improvements
                                                                                                                                                                                                                         -    - Links to relevant documentation
                                                                                                                                                                                                                          
                                                                                                                                                                                                                              - #### AI Agent Capabilities
                                                                                                                                                                                                                          
                                                                                                                                                                                                                              - The AI code review agent can identify:
                                                                                                                                                                                                                              - - **Common Bugs**: Off-by-one errors, null pointer dereferences, logic errors
                                                                                                                                                                                                                                - - **Security Issues**: SQL injection, XSS vulnerabilities, credential leaks
                                                                                                                                                                                                                                  - - **Performance**: Inefficient algorithms, memory leaks, unnecessary database calls
                                                                                                                                                                                                                                    - - **Best Practices**: Code style violations, anti-patterns, type safety issues
                                                                                                                                                                                                                                      - - **Testing Gaps**: Missing error handling, uncovered edge cases
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                        - #### Configuration
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                        - The AI Code Review feature:
                                                                                                                                                                                                                                        - - Automatically activates on all pull requests (organization-wide)
                                                                                                                                                                                                                                          - - Requires no additional configuration
                                                                                                                                                                                                                                            - - Uses Sentry's generative AI models
                                                                                                                                                                                                                                              - - Respects GitHub PR review permissions
                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                - ### Generative AI Features
                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                - The organization also has **"Show Generative AI Features"** enabled, which allows:
                                                                                                                                                                                                                                                - - AI-powered insights in Sentry issues
                                                                                                                                                                                                                                                  - - Stack trace analysis with suggestions
                                                                                                                                                                                                                                                    - - Automated issue descriptions
                                                                                                                                                                                                                                                      - - Performance optimization recommendations
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                        - ---
                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                        ## Integration & Workflow
                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                        ### Complete CI/CD Flow
                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                        ```
                                                                                                                                                                                                                                                        1. Developer pushes code
                                                                                                                                                                                                                                                           ↓
                                                                                                                                                                                                                                                        2. GitHub Actions triggers
                                                                                                                                                                                                                                                           ├─ Run tests with Jest
                                                                                                                                                                                                                                                           ├─ Generate coverage reports
                                                                                                                                                                                                                                                           └─ Upload to Codecov
                                                                                                                                                                                                                                                           ↓
                                                                                                                                                                                                                                                        3. Pull Request Created
                                                                                                                                                                                                                                                           ├─ Codecov comments with coverage change
                                                                                                                                                                                                                                                           └─ Sentry AI reviews code changes
                                                                                                                                                                                                                                                           ↓
                                                                                                                                                                                                                                                        4. Developer Reviews Comments
                                                                                                                                                                                                                                                           ├─ Address coverage gaps if needed
                                                                                                                                                                                                                                                           └─ Respond to AI suggestions
                                                                                                                                                                                                                                                           ↓
                                                                                                                                                                                                                                                        5. Code Merged to Main
                                                                                                                                                                                                                                                           ├─ Coverage history updated
                                                                                                                                                                                                                                                           └─ Metrics tracked in Codecov dashboard
                                                                                                                                                                                                                                                        ```
                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                        ### Required Environment Variables
                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                        For the workflow to function properly, ensure these are set:
                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                        **GitHub Repository Settings**:
                                                                                                                                                                                                                                                        - `CODECOV_TOKEN` (required) - Upload coverage reports
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                        - **Railway Deployment**:
                                                                                                                                                                                                                                                        - - `DATABASE_URL` - Connection string for production database
                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                          - ### Troubleshooting
                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                          - #### Coverage Not Uploading
                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                          - **Symptom**: Workflow runs but Codecov doesn't receive reports
                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                          - **Solutions**:
                                                                                                                                                                                                                                                          - 1. Verify `CODECOV_TOKEN` is set in GitHub Secrets
                                                                                                                                                                                                                                                            2. 2. Check workflow logs for upload errors
                                                                                                                                                                                                                                                               3. 3. Ensure Jest coverage reports are generated (`./coverage/coverage-final.json` exists)
                                                                                                                                                                                                                                                                  4. 4. Verify token has valid permissions in Codecov dashboard
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                     5. #### AI Code Review Not Commenting on PRs
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                     6. **Symptom**: Sentry AI bot doesn't comment on pull requests
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                     7. **Solutions**:
                                                                                                                                                                                                                                                                     8. 1. Confirm "Enable AI Code Review" is toggled ON in Sentry settings
                                                                                                                                                                                                                                                                        2. 2. Ensure GitHub integration is properly connected
                                                                                                                                                                                                                                                                           3. 3. Check that PR has sufficient code changes to analyze
                                                                                                                                                                                                                                                                              4. 4. Verify organization still has active AI features enabled
                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                 5. #### Tests Failing Locally but Not in CI
                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                 6. **Solutions**:
                                                                                                                                                                                                                                                                                 7. 1. Ensure Node.js version matches workflow (v18)
                                                                                                                                                                                                                                                                                    2. 2. Check that test database environment variables are set
                                                                                                                                                                                                                                                                                       3. 3. Verify PostgreSQL is running locally
                                                                                                                                                                                                                                                                                          4. 4. Check for timezone-dependent tests
                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                             5. ---
                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                             6. ## Next Steps
                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                             7. ### Recommended Actions
                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                             8. 1. **Add CODECOV_TOKEN to GitHub**
                                                                                                                                                                                                                                                                                                2.    - Go to Repository Settings → Secrets
                                                                                                                                                                                                                                                                                                      -    - Add the token from Codecov dashboard
                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                           - 2. **Configure Jest Coverage Thresholds**
                                                                                                                                                                                                                                                                                                             3.    - Update `jest.config.js` with desired coverage targets
                                                                                                                                                                                                                                                                                                                   -    - Set thresholds appropriate for your project
                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                        - 3. **Review First PR with AI**
                                                                                                                                                                                                                                                                                                                          4.    - Create a test PR to see AI Code Review in action
                                                                                                                                                                                                                                                                                                                                -    - Verify Codecov comments appear with coverage reports
                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                     - 4. **Monitor Coverage Trends**
                                                                                                                                                                                                                                                                                                                                       5.    - Watch Codecov dashboard as PRs are merged
                                                                                                                                                                                                                                                                                                                                             -    - Track coverage improvements over time
                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                  - ### Related Documentation
                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                  - - [Sentry Setup](../runbooks/SENTRY_ERROR_MONITORING.md) - Error monitoring and performance tracking
                                                                                                                                                                                                                                                                                                                                                    - - [CMC-Go Overview](./CMC_GO_OVERVIEW.md) - Project architecture
                                                                                                                                                                                                                                                                                                                                                      - - [GitHub Actions Documentation](https://docs.github.com/actions)
                                                                                                                                                                                                                                                                                                                                                        - - [Codecov Documentation](https://docs.codecov.io/)
                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                          - ---
                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                          ## Summary
                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                          Your CMC-Go project now has:
                                                                                                                                                                                                                                                                                                                                                          - ✅ Automated test execution on every commit
                                                                                                                                                                                                                                                                                                                                                          - - ✅ Code coverage tracking with Codecov
                                                                                                                                                                                                                                                                                                                                                            - - ✅ Pull request coverage reports
                                                                                                                                                                                                                                                                                                                                                              - - ✅ AI-powered code review on all PRs
                                                                                                                                                                                                                                                                                                                                                                - - ✅ Generative AI insights for error monitoring
                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                  - These tools work together to improve code quality, catch bugs early, and maintain visibility into test coverage and code health.
